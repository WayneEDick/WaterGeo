# Script_02_001.yaml â€” Water Geo (PNG-first)
# Pipeline:
# load_image -> binarize_png -> segment_lines -> extract_ccs ->
# estimate_baseline_and_xheight -> merge_ccs_to_glyphs ->
# infer_space_threshold_per_line -> insert_space_tokens ->
# identify_prose_runs_and_mask -> pick_residual -> islandify -> count_tokens

steps:
  - name: load_image
    args:
      path: input/input.png
    save: 01_gray.png

  - name: binarize_png
    args:
      method: otsu        # "otsu" or "fixed"
      invert: false
      blur_ksize: 0
      threshold: 200      # used only if method: fixed
    save: 02_ink.png

  - name: segment_lines
    args:
      eps_ink: 0
      min_valley_rows: 1
      cc_min_area: 5
    save: 03_lines.json

  - name: extract_ccs
    args:
      min_area: 5
      connectivity: 8
    save: 04_ccs.json

  - name: estimate_baseline_and_xheight
    args: {}
    save: 05_metrics.json

  - name: merge_ccs_to_glyphs
    args:
      pad_px: 1.0
    save: 06_glyphs.json

  - name: infer_space_threshold_per_line
    args:
      min_gaps_for_kmeans: 4
      fallback_cutoff_factor: 0.60
    save: 07_space_thresholds.json

  - name: insert_space_tokens
    args: {}
    save: 08_tokens_with_space.json

  - name: identify_prose_runs_and_mask
    args:
      min_run_tokens: 5
      max_token_height_factor: 2.5
      raised_marker_min_per_line: 2
      raised_center_factor: 0.45
    save: 09_prose_mask.json

  - name: pick_residual
    args: {}
    save: 10_residual.json

  - name: islandify
    args:
      pad: 1.0
    save: 11_islands.json

  - name: count_tokens
    args: {}
    save: 12_count.json
