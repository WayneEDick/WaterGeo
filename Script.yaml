# Script_02_000.yaml â€” Water Geo (PNG-first, CC-first, column-aware)
# Core pipeline:
# load_image -> binarize_png -> extract_ccs ->
# estimate_text_scale_from_ccs -> detect_graphics_blocks_from_ccs ->
# segment_columns_from_ccs -> assign_ccs_to_columns ->
# segment_lines_per_column_from_ccs -> merge_ccs_to_glyphs ->
# infer_space_threshold_per_line -> insert_space_tokens ->
# identify_prose_runs_and_mask -> pick_residual -> islandify -> count_tokens

steps:
  - name: load_image
    args:
      path: input/input.png
    save: 01_gray.png

  - name: binarize_png
    args:
      method: otsu
      invert: false
      blur_ksize: 0
      threshold: 200
    save: 02_ink.png

  - name: extract_ccs
    args:
      min_area: 5
      connectivity: 8
    save: 03_ccs.json

  - name: estimate_text_scale_from_ccs
    args:
      trim_top_frac: 0.10
      min_ccs: 50
      fallback_xheight: 16.0
    save: 04_text_scale.json

  - name: detect_graphics_blocks_from_ccs
    args:
      h_factor: 6.0
      w_factor: 20.0
      area_factor: 200.0
      pad_px: 2.0
    save: 05_graphics_blocks.json

  - name: segment_columns_from_ccs
    args:
      bins: 512
      gutter_max_frac: 0.20
      gutter_min_px: 12
      prefer_mid_frac: 0.35
      ignore_graphics: true
    save: 06_columns.json

  - name: assign_ccs_to_columns
    args:
      keep_spanning: true
      spanning_gutter_overlap_frac: 0.35
    save: 07_ccs_with_columns.json

  - name: segment_lines_per_column_from_ccs
    args:
      y_gap_factor: 0.80
      min_line_ccs: 8
      ignore_graphics: true
    save: 08_lines.json

  - name: merge_ccs_to_glyphs
    args:
      pad_px: 1.0
    save: 09_glyphs.json

  - name: infer_space_threshold_per_line
    args:
      min_gaps_for_kmeans: 4
      fallback_cutoff_factor: 0.60
    save: 10_space_thresholds.json

  - name: insert_space_tokens
    args: {}
    save: 11_tokens_with_space.json

  - name: identify_prose_runs_and_mask
    args:
      min_run_tokens: 5
      max_token_height_factor: 2.5
      raised_marker_min_per_line: 2
      raised_center_factor: 0.45
    save: 12_prose_mask.json

  - name: pick_residual
    args: {}
    save: 13_residual.json

  - name: islandify
    args:
      pad: 1.0
    save: 14_islands.json

  - name: count_tokens
    args: {}
    save: 15_count.json
